############################# Filebeat ######################################

# collector, aggregator, appagent (aggregator-collector), worker, platform
filebeat:
  inputs:
    - type: 'filestream'
      id: 'filestream-${SERVICE_TYPE}'
      enabled: true
      processors:
        - add_fields:
            target: ''
            fields:
              service.name: 'aparavi'
              service.component: '${SERVICE_TYPE}'
              service.subcomponent: 'app'
        - add_locale:
            format: 'offset'
      harvester_limit: 32
      prospector.scanner.check_interval: '15s'
      ignore_older: '24h'
      close.on_state_change.inactive: '2m'
      parsers:
        - multiline:
            type: 'pattern'
            pattern: '^\d{1,2}\/\d{1,2}\/\d{4}, \d{1,2}:\d{2}:\d{2} (AM|PM)'
            negate: true
            match: 'after'
      paths:
        - '/var/log/aparavi*/${SERVICE_FOLDER}/*'
        - '/opt/aparavi*/${SERVICE_FOLDER}/monitor.log*'
    - type: 'udp'
      enabled: true
      host: '127.0.0.1:5140'
      max_message_size: '32KiB'
      fields:
        event.provider: 'syslog'
      fields_under_root: true
      processors:
        - decode_json_fields:
            fields: ['message']
            overwrite_keys: true
            target: ''
        - add_fields:
            target: ''
            fields:
              service.name: 'aparavi'
              service.component: 'app'
              service.subcomponent: '${SERVICE_TYPE}'
        - drop_fields:
            when:
              equals:
                process.pid: '-'
            fields:
              - 'process.pid'
            ignore_missing: true
  modules:
    - module: 'mysql'
      error:
        enabled: true
        var.paths:
          - '/var/log/mysql/*.err*'
          - '/var/log/mysql/error.log*'
      slowlog:
        enabled: true
        var.paths:
          - '/var/log/mysql/*-slow.log*'

processors:
  - drop_fields:
      fields:
        - 'agent.ephemeral_id'
        - 'agent.hostname'
        - 'agent.id'
        - 'agent.name'
        - 'agent.type'
        - 'agent.version'
        - 'ecs.version'
        - 'event.original'
        - 'input.type'
        - 'log.source.address'
        - 'log.offset'
      ignore_missing: true
  - add_fields:
      target: ''
      fields:
        service.environment: '${ENV}'
      when:
        not:
          has_fields: ['service.environment']
  - add_fields:
      target: ''
      fields:
        service.instance: '${SERVICE_CLIENT}'
      when:
        not:
          has_fields: ['service.instance']

queue.spool:
  file:
    path: '${path.data}/spool.dat'
    size: '50MiB'
    page_size: '16KiB'
  write:
    buffer_size: '10MiB'
    flush.timeout: '5s'

############################# Libbeat Config ##################################
# Base config file used by all other beats for using libbeat features

############################# Output ##########################################

output:
  logstash:
    timeout: 5
    hosts:
      - '${LOGSTASH}:5044'
    ssl:
      enabled: true
      verification_mode: 'strict'

############################# Logging #########################################

logging:
  level: 'info'
  to_files: true
  files:
    name: 'filebeat'
    keepfiles: 3
    rotateeverybytes: 20000000
